<!-- views/administracion/lista.ejs -->
<%- include('../partials/header', { title: 'Administración - ' + tabla }) %>
<%- include('../partials/navbar') %>
<%- include('../partials/sidebar') %>
<%- include('../partials/content-wrapper-open') %>

<style>
  .table td {
    vertical-align: middle;
  }
  .btn-group .btn {
    margin-right: 5px;
  }
  .action-buttons .btn {
    margin-right: 10px;
  }
</style>

<div class="container-xxl flex-grow-1 container-p-y">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
    <div>
      <h4 class="mb-1">Lista de <%= tabla.charAt(0).toUpperCase() + tabla.slice(1) %></h4>
      <p class="mb-0">Gestión de registros en la tabla <%= tabla %>.</p>
    </div>
    <div class="d-flex action-buttons">
      <a href="/administracion" class="btn btn-secondary me-2">
        <i class="fas fa-arrow-left me-1"></i> Regresar
      </a>
      <a href="/administracion/<%= tabla %>/crear" class="btn btn-primary">
        <i class="fas fa-plus me-1"></i> Crear Nuevo
      </a>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table id="tabla-registros" class="table table-hover w-100">
          <thead>
            <tr>
              <% if (registros.length > 0) { %>
                <% if (columnas && Array.isArray(columnas)) { %>
                  <% columnas.forEach(columna => { %>
                    <th><%= columna.nombre.charAt(0).toUpperCase() + columna.nombre.slice(1).toLowerCase() %></th>
                  <% }) %>
                  <th>Acciones</th>
                <% } else { %>
                  <th>Columnas no definidas</th>
                <% } %>
              <% } else { %>
                <th>No hay registros</th>
              <% } %>
            </tr>
          </thead>
          <tbody>
            <% if (registros.length > 0 && columnas && Array.isArray(columnas)) { %>
              <% registros.forEach(registro => { %>
                <tr>
                  <% columnas.forEach(columna => { %>
                    <% 
                      let valor = registro[columna.nombre];
                      // Formatear el valor según el tipo
                      if (columna.tipo.toLowerCase() === 'datetime' && valor) {
                        valor = new Date(valor).toLocaleString('es-ES', { 
                          year: 'numeric', 
                          month: '2-digit', 
                          day: '2-digit', 
                          hour: '2-digit', 
                          minute: '2-digit',
                          second: '2-digit'
                        });
                      } else if (columna.tipo.toLowerCase() === 'bit') {
                        valor = valor === 1 || valor === '1' ? 'Sí' : 'No';
                      }
                    %>
                    <td><%= valor === null ? 'null' : valor %></td>
                  <% }) %>
                  <td>
                    <div class="btn-group" role="group">
                      <a href="/administracion/<%= tabla %>/editar/<%= registro[idColumna] %>" class="btn btn-sm btn-outline-secondary" title="Editar">
                        <i class="fas fa-edit"></i>
                      </a>
                      <form action="/administracion/<%= tabla %>/eliminar/<%= registro[idColumna] %>" method="POST" style="display:inline-block;">
                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Eliminar" onclick="return confirm('¿Estás seguro de eliminar este registro?');">
                          <i class="fas fa-trash-alt"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer-text') %>
<%- include('../partials/footer') %>
<%- include('../partials/content-wrapper-close') %>

<script>
  $(document).ready(function() {
    $('#tabla-registros').DataTable({
      responsive: true,
      autoWidth: false,
      language: {
        url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json",
        search: "",
        emptyTable: "No hay registros disponibles."
      },
      pageLength: 10,
      lengthChange: false,
      order: [],
      columnDefs: [
        {
          targets: -1,
          orderable: false,
          searchable: false,
          responsivePriority: 1
        },
        {
          targets: 0,
          responsivePriority: 2
        },
        {
          targets: '_all',
          responsivePriority: 3
        }
      ],
      initComplete: function () {
        var dataTableFilter = $('#tabla-registros_filter');
        var searchInput = dataTableFilter.find('input').detach();
        dataTableFilter.empty();

        var searchInputGroup = $('<div class="input-group"></div>');
        var searchIcon = $('<span class="input-group-text"><i class="fas fa-search"></i></span>');
        searchInput.addClass('form-control').attr('placeholder', 'Buscar...');
        searchInputGroup.append(searchIcon).append(searchInput);

        dataTableFilter.append(searchInputGroup);
        dataTableFilter.css('float', 'left');
      }
    });
  });
</script>